#!/bin/bash -e

# Â© Copyright IBM Corporation 2020
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

function setup_MQSERVER {
    export MQSERVER=RDQM.SVRCONN/TCP/${RDQM_IP1}\(${RDQM_PORT}\)
}

# The first thing to check is which executable has been specified

if [[ -z "${RDQM_EXECUTABLE}" ]]
then
    echo "Environment variable RDQM_EXECUTABLE must be set to either rdqmget or rdqmput"
    exit 1
else
    case "$RDQM_EXECUTABLE" in
        rdqmget|rdqmput)
            ;;
        *)
            exit 1
            ;;
    esac
fi

if [[ -z "${RDQM_IP1}" ]]
then
    echo "Environment variable RDQM_IP1 must be specified"
    exit 1
fi

if [[ -z "${RDQM_PORT}" ]]
then
    echo "Environment variable RDQM_PORT must be specified"
    exit 1
fi

if [[ -z "${RDQM_QMGRNAME}" ]]
then
    echo "Environment variable RDQM_QMGRNAME must be specified"
    exit 1
fi

if [[ -z "${RDQM_QNAME}" ]]
then
    echo "Environment variable RDQM_QNAME must be specified"
    exit 1
fi

setup_MQSERVER

# Now process options

options=""

if [[ -n "${RDQM_USER}" ]]
then
    options+=" -u $RDQM_USER"
else
    options+=" -u rdqmuser"
fi

if [[ -n "${RDQM_VERBOSITY}" ]]
then
    options+=" -v $RDQM_VERBOSITY"
fi

case "$RDQM_EXECUTABLE" in
    rdqmget)
        echo "/IBM/MQ/s2i/src/linux/rdqmget $options $RDQM_QMGRNAME $RDQM_QNAME"
        exec /IBM/MQ/s2i/src/linux/rdqmget $options $RDQM_QMGRNAME $RDQM_QNAME
    ;;
    rdqmput)
        echo "/IBM/MQ/s2i/src/linux/rdqmput $options $RDQM_QMGRNAME $RDQM_QNAME"
        exec /IBM/MQ/s2i/src/linux/rdqmput $options $RDQM_QMGRNAME $RDQM_QNAME
    ;;
    *)
        exit 1
    ;;
esac
